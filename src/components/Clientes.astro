---
/**
 * ClienteMetricasFuturistas.astro
 * Componente Astro con Tailwind que ofrece 2 vistas: "nebula" (por defecto) y "hologram".
 * Pásale { metricas, vista } por props, o edita el objeto defaultMetricas.
 */
import '../styles/global.css';
interface Metricas {
  id: number;
  id_cliente: number;
  ano: number;
  mes: number; // 1-12
  puntuacion_volumen: number; // 0-3
  puntuacion_margen: number; // 0-3
  puntuacion_recency: number; // 0-3
  puntuacion_frecuencia: number; // 0-3
  ponderacion_vcs: number; // p.ej. 1.17
  nombre_empresa?: string;
  volumen_total?: number; // m³
  margen_promedio?: number; // %
  recency?: string | number; // "Hace X días" o número de días
  frecuencia?: string | number; // "X/mes"
}

const defaultMetricas: Metricas = {
  id: 100,
  id_cliente: 4107,
  ano: 2025,
  mes: 3,
  puntuacion_volumen: 2,
  puntuacion_margen: 2,
  puntuacion_recency: 1,
  puntuacion_frecuencia: 1,
  ponderacion_vcs: 1.17,
  nombre_empresa: "ACME S.A.",
  volumen_total: 0,
  margen_promedio: 0,
  recency: "—",
  frecuencia: "—",
};

const { metricas: incoming, vista = 'nebula' }: { metricas?: Partial<Metricas>; vista?: 'nebula' | 'hologram' } = Astro.props;
const metricas: Metricas = { ...defaultMetricas, ...(incoming || {}) } as Metricas;

const pct = (score: number, max = 3) => Math.max(0, Math.min(100, Math.round(((score ?? 0) / max) * 100)));
const monthStr = new Date(metricas.ano, (metricas.mes ?? 1) - 1, 1).toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
---

<!-- Fondo futurista con auroras y rejilla sutil -->
<section class="min-h-screen relative overflow-hidden bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-900 text-white selection:bg-indigo-300 selection:text-black">
  <!-- Nebulosa/auroras -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 opacity-60">
    <div class="absolute -top-40 -left-40 h-96 w-96 rounded-full blur-3xl bg-indigo-600/30"></div>
    <div class="absolute top-1/3 -right-24 h-[26rem] w-[26rem] rounded-full blur-3xl bg-fuchsia-500/25"></div>
    <div class="absolute bottom-0 left-1/4 h-72 w-72 rounded-full blur-3xl bg-cyan-400/20"></div>
  </div>
  <!-- Rejilla -->
  <div aria-hidden="true" class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(99,102,241,0.15),transparent_40%),radial-gradient(circle_at_80%_0%,rgba(168,85,247,0.10),transparent_35%)]"></div>

  <!-- Controles de vista (opcional) -->
  <div class="relative z-10 flex justify-center pt-8">
    <div class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 backdrop-blur px-2 py-1 shadow-lg">
      <button id="btnNebula" class="px-3 py-1.5 text-sm rounded-full data-[active=true]:bg-indigo-500/30 data-[active=true]:text-white text-slate-300 hover:text-white transition" data-active={vista === 'nebula'}>Nebula</button>
      <button id="btnHologram" class="px-3 py-1.5 text-sm rounded-full data-[active=true]:bg-indigo-500/30 data-[active=true]:text-white text-slate-300 hover:text-white transition" data-active={vista === 'hologram'}>Hologram</button>
    </div>
  </div>

  <!-- VISTA 1: NEBULA (tarjeta glass + anillos) -->
  {vista === 'nebula' && (
    <div class="relative z-10 mx-auto my-10 w-full max-w-5xl p-6 sm:p-8">
      <div class="relative rounded-3xl border border-indigo-500/20 bg-white/5 p-8 shadow-2xl backdrop-blur-xl overflow-hidden group hover:shadow-[0_0_60px_rgba(129,140,248,0.25)] transition-all">
        <!-- Borde brillante animado -->
        <div aria-hidden class="pointer-events-none absolute inset-0 rounded-3xl [mask-image:radial-gradient(ellipse_at_center,black,transparent_70%)]">
          <div class="absolute -inset-[1px] rounded-3xl bg-[conic-gradient(from_180deg_at_50%_50%,rgba(99,102,241,0.25),rgba(168,85,247,0.20),rgba(34,211,238,0.15),rgba(99,102,241,0.25))] animate-[spin_12s_linear_infinite]"></div>
        </div>

        <header class="relative">
          <h1 class="text-center text-3xl md:text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 via-cyan-200 to-fuchsia-300 drop-shadow">
            Métricas del Cliente
          </h1>
          <p class="mt-2 text-center text-sm text-indigo-200/70">
            {metricas.nombre_empresa ?? '—'} · ID {metricas.id_cliente}
          </p>
          <div class="mx-auto mt-4 h-px w-48 bg-gradient-to-r from-transparent via-indigo-400/60 to-transparent"></div>
        </header>

        <!-- Grid principal -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-5">
          <!-- Fecha -->
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Periodo</span>
            <div class="mt-2 flex items-end gap-2">
              <span class="text-2xl font-bold">{monthStr}</span>
            </div>
            <p class="mt-1 text-xs text-slate-300/70">Año {metricas.ano}</p>
          </div>

          <!-- Volumen total -->
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Volumen total</span>
            <div class="mt-2 flex items-end gap-2">
              <span class="text-2xl font-bold">{metricas.volumen_total ?? '—'}</span>
              <span class="text-sm text-slate-300/70">m³</span>
            </div>
            <p class="mt-1 text-xs text-slate-300/70">Puntuación <span class="text-indigo-300">{metricas.puntuacion_volumen}</span></p>
          </div>

          <!-- Margen promedio -->
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Margen promedio</span>
            <div class="mt-2 flex items-end gap-2">
              <span class="text-2xl font-bold">{metricas.margen_promedio ?? '—'}</span>
              <span class="text-sm text-slate-300/70">%</span>
            </div>
            <p class="mt-1 text-xs text-slate-300/70">Puntuación <span class="text-indigo-300">{metricas.puntuacion_margen}</span></p>
          </div>

          <!-- Recency -->
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Recency</span>
            <div class="mt-2 text-2xl font-bold">{metricas.recency ?? '—'}</div>
            <p class="mt-1 text-xs text-slate-300/70">Puntuación <span class="text-indigo-300">{metricas.puntuacion_recency}</span></p>
          </div>

          <!-- Frecuencia -->
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Frecuencia</span>
            <div class="mt-2 text-2xl font-bold">{metricas.frecuencia ?? '—'}</div>
            <p class="mt-1 text-xs text-slate-300/70">Puntuación <span class="text-indigo-300">{metricas.puntuacion_frecuencia}</span></p>
          </div>

          <!-- Ponderación VCS -->
          <div class="relative rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur hover:-translate-y-0.5 hover:shadow-xl transition-all">
            <span class="text-xs uppercase tracking-widest text-indigo-300/80">Ponderación VCS</span>
            <div class="mt-3 flex items-center gap-4">
              <!-- Gauge circular -->
              <div class="relative grid place-content-center">
                <div class="relative h-20 w-20 rounded-full" style={`--p:${Math.min(100, Math.round((metricas.ponderacion_vcs ?? 0) * 50))}`}> <!-- mapa 0..2 -> 0..100 -->
                  <div class="absolute inset-0 rounded-full bg-[conic-gradient(#8b5cf6_calc(var(--p)*1%),rgba(255,255,255,0.08)_0)]"></div>
                  <div class="absolute inset-2 rounded-full bg-slate-900/60 backdrop-blur"></div>
                </div>
                <span class="absolute inset-0 grid place-content-center text-xl font-bold">{metricas.ponderacion_vcs}</span>
              </div>

            </div>
          </div>
        </div>

        <!-- Línea -->
        <div class="my-8 h-px w-full bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

        <!-- Anillos de puntuación -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          {[
            { label: 'Volumen', score: metricas.puntuacion_volumen },
            { label: 'Margen', score: metricas.puntuacion_margen },
            { label: 'Recency', score: metricas.puntuacion_recency },
            { label: 'Frecuencia', score: metricas.puntuacion_frecuencia },
          ].map(({ label, score }) => (
            <div class="relative rounded-2xl border border-white/10 bg-white/5 p-4 text-center backdrop-blur group hover:shadow-[0_0_30px_rgba(129,140,248,0.2)] transition-all">
              <div class="mx-auto relative h-20 w-20">
                <div class="absolute inset-0 rounded-full" style={`--p:${pct(score)}`}>
                  <div class="absolute inset-0 rounded-full bg-[conic-gradient(#a78bfa_calc(var(--p)*1%),rgba(255,255,255,0.08)_0)]"></div>
                  <div class="absolute inset-2 rounded-full bg-slate-900/60 backdrop-blur"></div>
                </div>
                <div class="absolute inset-0 grid place-content-center">
                  <span class="text-2xl font-bold">{score}</span>
                </div>
              </div>
              <p class="mt-2 text-xs uppercase tracking-wider text-indigo-200/80">{label}</p>
            </div>
          ))}
        </div>

        <div class="mt-10 flex justify-center">
          <a href="#" class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-600 px-6 py-2.5 font-semibold shadow-lg shadow-fuchsia-600/20 hover:scale-105 active:scale-100 transition-transform">
            Ver más detalles
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="opacity-90"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </a>
        </div>
      </div>
    </div>
  )}

  <!-- VISTA 2: HOLOGRAM (layout alternativo: panel dividido + barras verticales) -->
  {vista === 'hologram' && (
    <div class="relative z-10 mx-auto my-10 w-full max-w-6xl p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- Panel de contexto -->
        <div class="lg:col-span-3 relative overflow-hidden rounded-3xl border border-cyan-400/20 bg-gradient-to-br from-slate-900/70 via-slate-900/50 to-slate-800/60 p-7 backdrop-blur-xl shadow-2xl">
          <div aria-hidden class="pointer-events-none absolute -inset-1 rounded-3xl bg-[conic-gradient(from_90deg_at_50%_50%,rgba(34,211,238,0.10),rgba(99,102,241,0.12),rgba(236,72,153,0.08),rgba(34,211,238,0.10))] animate-[spin_18s_linear_infinite]"></div>
          <div class="relative">
            <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200/80">
              <span class="h-2 w-2 rounded-full bg-cyan-400 animate-pulse"></span>
              <span>ID {metricas.id_cliente}</span>
            </div>
            <h2 class="mt-4 text-2xl md:text-3xl font-extrabold tracking-tight">
              {metricas.nombre_empresa}
            </h2>
            <p class="mt-1 text-sm text-slate-300/80">Periodo: {monthStr}</p>

            <div class="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-4">
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <p class="text-xs text-cyan-200/80 uppercase tracking-widest">Volumen total</p>
                <p class="mt-1 text-2xl font-bold">{metricas.volumen_total ?? '—'}<span class="ml-1 text-sm text-slate-300/70">m³</span></p>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <p class="text-xs text-cyan-200/80 uppercase tracking-widest">Margen promedio</p>
                <p class="mt-1 text-2xl font-bold">{metricas.margen_promedio ?? '—'}<span class="ml-1 text-sm text-slate-300/70">%</span></p>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <p class="text-xs text-cyan-200/80 uppercase tracking-widest">VCS</p>
                <p class="mt-1 text-2xl font-bold">{metricas.ponderacion_vcs}</p>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <p class="text-xs text-cyan-200/80 uppercase tracking-widest">Recency</p>
                <p class="mt-1 text-2xl font-bold">{metricas.recency ?? '—'}</p>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <p class="text-xs text-cyan-200/80 uppercase tracking-widest">Frecuencia</p>
                <p class="mt-1 text-2xl font-bold">{metricas.frecuencia ?? '—'}</p>
              </div>
            </div>

            <!-- CTA -->
            <div class="mt-6 flex flex-wrap items-center gap-3">
              <a href="#" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-cyan-500 to-fuchsia-600 px-5 py-2 font-semibold shadow-lg shadow-cyan-500/20 hover:scale-[1.02] transition">
                Abrir cliente
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="opacity-90"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </a>
              <span class="text-xs text-slate-300/70">Año {metricas.ano}</span>
            </div>
          </div>
        </div>

        <!-- Panel de puntuaciones (barras) -->
        <div class="lg:col-span-2 relative overflow-hidden rounded-3xl border border-fuchsia-400/20 bg-gradient-to-b from-slate-900/70 via-slate-900/40 to-slate-900/70 p-7 backdrop-blur-xl shadow-2xl">
          <h3 class="text-sm uppercase tracking-widest text-fuchsia-200/80">Puntuaciones</h3>
          <div class="mt-6 grid grid-cols-4 gap-4">
            {[
              { label: 'Volumen', score: metricas.puntuacion_volumen },
              { label: 'Margen', score: metricas.puntuacion_margen },
              { label: 'Recency', score: metricas.puntuacion_recency },
              { label: 'Frecuencia', score: metricas.puntuacion_frecuencia },
            ].map(({ label, score }) => (
              <div class="flex flex-col items-center">
                <div class="relative h-40 w-12 rounded-xl border border-white/10 bg-white/5 p-1">
                  <div class="absolute inset-0 rounded-xl bg-gradient-to-b from-fuchsia-500/10 to-transparent"></div>
                  <div class="absolute bottom-1 left-1 right-1 rounded-lg bg-gradient-to-t from-fuchsia-500 to-cyan-400" style={`height:${pct(score)}%`}></div>
                </div>
                <span class="mt-2 text-xs text-slate-300/80">{label}</span>
                <span class="text-sm font-bold">{score}</span>
              </div>
            ))}
          </div>

          <!-- Gauge VCS grande -->
          <div class="mt-8 grid place-content-center">
            <div class="relative h-40 w-40" style={`--p:${Math.min(100, Math.round((metricas.ponderacion_vcs ?? 0) * 50))}`}> <!-- 0..2 -> 0..100 -->
              <div class="absolute inset-0 rounded-full bg-[conic-gradient(#06b6d4_calc(var(--p)*1%),rgba(255,255,255,0.06)_0)]"></div>
              <div class="absolute inset-3 rounded-full bg-slate-900/70 backdrop-blur"></div>
              <div class="absolute inset-0 grid place-content-center text-center">
                <div class="text-3xl font-extrabold">{metricas.ponderacion_vcs}</div>
                <div class="text-xs uppercase tracking-widest text-slate-300/70">VCS</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )}

  <script is:inline>
    // Toggle rápido en cliente (opcional)
    const btnN = document.getElementById('btnNebula');
    const btnH = document.getElementById('btnHologram');
    if (btnN && btnH) {
      const set = (mode) => {
        btnN.dataset.active = String(mode === 'nebula');
        btnH.dataset.active = String(mode === 'hologram');
        // Navega con hash en vez de rehidratar; en producción quizá prefieras props
        if (location.hash !== '#' + mode) location.hash = '#' + mode;
        // Mostrar/ocultar vistas sin refrescar
        const neb = document.querySelector('[data-astro-cid]')?.querySelectorAll?.('[data-view]');
      };
      btnN.addEventListener('click', () => set('nebula'));
      btnH.addEventListener('click', () => set('hologram'));
      // Init desde hash si existe
      const initial = location.hash.replace('#','');
      if (initial === 'nebula' || initial === 'hologram') {
        (initial === 'nebula' ? btnN : btnH).click();
      }
    }
  </script>
</section>
